{% load static %}
{% include "common/head_admin.html" %}

<div class="wrap">
    <div class="admin_sub_visual">
         <div class="tabs section_wrap">
            <ul>
                <li><a href="/deposit_list/">무통장 입금 조회</a></li>
                <li ><a href="/pay_list/">구매 데이터 조회</a></li>
                <li><a href="/user_list/">사용자 조회</a></li>
                <li class="admin_active"><a href="/refund_list/">환불</a></li>
                 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <li><a href="https://admin.iamport.kr/users/login" target="_blank">아임포트 관리자</a></li>
                <li><a href="https://partner.danalpay.com/account/login?next=%2F#" target="_blank">다날 (휴대폰인증)</a></li>
                <li><a href="http://admin8.kcp.co.kr" target="_blank">KCP</a></li>
            </ul>
        </div>
    </div>

    <div class="codingLounge_list" style="margin-left:300px;">
        <div class="filter_area fixed">
            <div class="search_area">
                <div class="input_area_lounge">
                     <input type="date" name="start_date" id="start_date" value="{{start_date}}">
                </div>
                <div class="input_area_lounge">
                     <input type="date" name="end_date" id="end_date" value="{{end_date}}">
                </div>
                <div class="input_area_lounge">
                      <select id="page_cnt" name="page_cnt" style="width:60px; height:35px; border:1px solid #d4d4d4; line-height:30px; font-size:12px;">
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                     </select>
                </div>
                <div class="input_area_lounge" style="margin-left:-220px;">
                     <input type="text" name="search_box" id="search_box" value='{{search}}' placeholder="아이디 or 주문번호">
                </div>
                 <div class="btn_area">
                    <a class="btn" href="javascript:void(0);" onclick="javascript:goSearch(1);">&nbsp;조회하기&nbsp;</a>
                 </div>
            </div>
        </div>
    </div>

    <div style="margin-left: 300px; width: 1130px; font-size: 20px !important; padding-bottom:10px;">total : {{total_count}}
    </div>
    <div style="overflow: hidden; position: relative; border: 0px; width: 100%;">
        <table id="payList" style="margin-left: 300px; width: 1130px;">
            <thread>
                <tr class="row">
                    <th class="admin_list">이름</th>
                    <th class="admin_list_id">주문번호</th>
                    <th class="admin_list_id">환불키트</th>
                    <th class="admin_list">키트가격</th>
                    <th class="admin_list_id">옵션가격</th>
                    <th class="admin_list">총결제금액</th>
                    <th class="admin_list">배송지정보</th>
                    <th class="admin_list_id">결제일</th>
                    <th class="admin_list">결제방법</th>
                    <th class="admin_list_id">환불금액</th>
                    <th class="admin_list_id">메세지</th>
                    <th class="admin_list">환불취소</th>
                    <th class="admin_list">환불</th>
                </tr>
            </thread>
            <tbody>
                {% for refund in refund_info %}
                <tr class="row">
                    <td class="admin_list_body">
                        <a href="javascript:alert('{{refund.user_email}}, {{refund.user_number}}')">{{refund.user_name}}</a>
                    </td>
                    <td class="admin_list_id_body">
                       {{refund.pay_num}}
                    </td>
                   <td class="admin_list_id_body">
                       {{refund.prd_title}}
                    </td>
                    <td class="admin_list_body">
                       {{refund.prd_price}}원
                    </td>
                     <td class="admin_list_body">
                         {% if refund.option1 != "" %}
                            {{refund.option1}} - {{refund.option1_price}}원 <br/>
                         {% endif %}
                          {% if refund.option2 != "" %}
                            {{refund.option2}} - {{refund.option2_price}}원 <br/>
                         {% endif %}
                          {% if refund.option3 != "" %}
                            {{refund.option3}} - {{refund.option3_price}}원 <br/>
                         {% endif %}
                    </td>
                     <td class="admin_list_body">
                       {{refund.prd_total_price }}원
                    </td>
                    <td class="admin_list_body">
                       <a href="javascript:alert('{{refund.delivery_addr}}\n{{refund.delivery_name}}, {{refund.delivery_phone}}\n배송비 :  {{refund.delivery_price}}원 \n배송보낸 날 : {{refund.delivery_time | date:'Y-m-d'}}');">확인</a>
                    </td>
                    <td class="admin_list_id_body">
                       {{refund.pay_time  | date:'Y-m-d' }}
                    </td>
                     <td class="admin_list_body">
                        {% if refund.pay_way == 'deposit' %}
                            <a href="javascript:alert('{{refund.payWay_name}}, {{refund.payWay_account}}');">{{refund.pay_way}}</a>
                        {% else %}
                            {{refund.pay_way}}
                        {% endif %}
                    </td>
                    <td class="admin_list_id_body">
                        {% if refund.dbstat == 'A' %}
                            <input type="text" id="refund_price_{{refund.refund_idx}}" value={{refund.refund_price}} style="width:50px; height:20px; font-size:12px; font-family: inherit;">원
                         {% else %}
                           {{refund.refund_price}}원
                        {% endif %}
                    </td>
                    <td class="admin_list_id_body">
                        {% if refund.dbstat == 'A' %}
                            <input type="text" id="refund_msg_{{refund.refund_idx}}" style="width:100px; height:20px; font-size:12px; font-family: inherit;">
                        {% else %}
                           {{refund.reason}}
                        {% endif %}
                    </td>
                    <td class="admin_list_body">
                        {% if refund.dbstat == 'A' %}
                            <a href="javascript:void(0);" onClick="javascript:rollback('{{refund.refund_idx}}', '{{paging_num}}');" style="cursor:pointer;">환불취소</a>
                        {% endif %}
                    </td>
                    <td class="admin_list_body">
                        {% if refund.dbstat == 'A' %}
                            <a href="javascript:void(0);" onClick="javascript:refund('{{refund.refund_idx}}', '{{paging_num}}');" style="cursor:pointer;color:red;"><strong>환불하기</strong></a>
                        {% else %}
                            환불완료
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div id="total_data" class="page"><span>조회 데이터가 없습니다.</span></div>
        <div class="page">
            <ul id="paging" class="pagination modal"></ul>
        </div>
    </div>

</div>

    <script>

     $(document).ready(function() {
       $('#status').val('{{status}}').prop("selected",true);
       $('#page_cnt').val('{{page_cnt}}').prop("selected",true);

       var total = '{{total_count}}';
       if (total == 0)
       {
            $("#total_data").show();
            $("#excel").attr('disabled', true);
            $("#delivery").attr('disabled', true);
       }
       else
       {
            $("#total_data").hide();
            $("#excel").attr('disabled', false);
            $("#delivery").attr('disabled', false);
       }

       var page = '{{last_page}}';
       var cur_page = '{{paging_num}}';

       page *= 1;

       for(var i = 1; i <= page; i ++)
       {
            if(i == cur_page)
                document.getElementById('paging').innerHTML += "<li><a href='javascript:void(0);' onclick='javascript:goSearch(" + i + ");' class='active num' >" + i + "</a></li>";
            else
                document.getElementById('paging').innerHTML += "<li><a href='javascript:void(0);' onclick='javascript:goSearch(" + i + ");' class='num' >" + i + "</a></li>";
       }

     });

     function goSearch(paging_num)
     {
        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;
        var page_cnt = document.getElementById('page_cnt').value;
        var searchBox = $('[name=search_box]').val();

        if(start_date == "" || end_date == "")
        {
            alert("날짜선택하세요");
            return false;
        }

        if(start_date > end_date)
        {
            alert("날짜 설정을 다시 해주세요");
            return false;
        }


        var newForm = $('<form></form>');

        newForm.attr("name", "refund_search");
        newForm.attr("method", "post");
        newForm.attr("action", "/refund_search/");

        newForm.append($('<input/>', {type: 'hidden', name: 'csrfmiddlewaretoken', value : '{{ csrf_token }}'}));
        newForm.append($('<input/>', {type: 'hidden', name: 'start_date', value : start_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'end_date', value : end_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'searchBox', value : searchBox }));
        newForm.append($('<input/>', {type: 'hidden', name: 'paging_num', value : paging_num }));
        newForm.append($('<input/>', {type: 'hidden', name: 'page_cnt', value : page_cnt }));

        newForm.appendTo('body');
        newForm.submit();

     }

    function refund(refund_idx, paging_num)
    {
        var refund_price = document.getElementById('refund_price_'+refund_idx).value;
        var refund_msg = document.getElementById('refund_msg_'+refund_idx).value;

        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;
        var page_cnt = document.getElementById('page_cnt').value;
        var searchBox = $('[name=search_box]').val();

        var newForm = $('<form></form>');

        newForm.attr("name", "user_refund");
        newForm.attr("method", "post");
        newForm.attr("action", "/user_refund/");

        newForm.append($('<input/>', {type: 'hidden', name: 'csrfmiddlewaretoken', value : '{{ csrf_token }}'}));
        newForm.append($('<input/>', {type: 'hidden', name: 'refund_price', value : refund_price }));
        newForm.append($('<input/>', {type: 'hidden', name: 'refund_idx', value : refund_idx }));
        newForm.append($('<input/>', {type: 'hidden', name: 'refund_msg', value : refund_msg }));
        newForm.append($('<input/>', {type: 'hidden', name: 'start_date', value : start_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'end_date', value : end_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'searchBox', value : searchBox }));
        newForm.append($('<input/>', {type: 'hidden', name: 'paging_num', value : paging_num }));
        newForm.append($('<input/>', {type: 'hidden', name: 'page_cnt', value : page_cnt }));

        newForm.appendTo('body');
        newForm.submit();

    }

    function rollback(refund_idx, paging_num)
    {
        var refund_msg = document.getElementById('refund_msg_'+refund_idx).value;

        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;
        var page_cnt = document.getElementById('page_cnt').value;
        var searchBox = $('[name=search_box]').val();

        var newForm = $('<form></form>');

        newForm.attr("name", "user_refund_rollback");
        newForm.attr("method", "post");
        newForm.attr("action", "/user_refund_rollback/");

        newForm.append($('<input/>', {type: 'hidden', name: 'csrfmiddlewaretoken', value : '{{ csrf_token }}'}));
        newForm.append($('<input/>', {type: 'hidden', name: 'refund_idx', value : refund_idx }));
        newForm.append($('<input/>', {type: 'hidden', name: 'refund_msg', value : refund_msg }));
        newForm.append($('<input/>', {type: 'hidden', name: 'start_date', value : start_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'end_date', value : end_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'searchBox', value : searchBox }));
        newForm.append($('<input/>', {type: 'hidden', name: 'paging_num', value : paging_num }));
        newForm.append($('<input/>', {type: 'hidden', name: 'page_cnt', value : page_cnt }));

        newForm.appendTo('body');
        newForm.submit();

    }


    </script>
</body></html>