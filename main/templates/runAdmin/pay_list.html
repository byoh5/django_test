{% load static %}
{% include "common/head_admin.html" %}

<div class="wrap">
    <div class="admin_sub_visual">
         <div class="tabs section_wrap">
            <ul>
                <li><a href="/deposit_list/">무통장 입금 조회</a></li>
                <li class="admin_active"><a href="/pay_list/">구매 데이터 조회</a></li>
                <li><a href="/user_list/">사용자 조회</a></li>
                 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <li><a href="https://admin.iamport.kr/users/login" target="_blank">아임포트 관리자</a></li>
                <li><a href="https://partner.danalpay.com/account/login?next=%2F#" target="_blank">다날 (휴대폰인증)</a></li>
                <li><a href="http://admin8.kcp.co.kr" target="_blank">KCP</a></li>
            </ul>
        </div>
    </div>

    <div class="codingLounge_list" style="margin-left:280px;">
        <div class="filter_area fixed">
            <div class="search_area">
                <div class="input_area_lounge">
                     <input type="date" name="start_date" id="start_date" value="{{start_date}}">
                </div>
                <div class="input_area_lounge">
                     <input type="date" name="end_date" id="end_date" value="{{end_date}}">
                </div>
                <div class="input_area_lounge">
                      <select id="status" name="status" style="width:200px; height:35px; border:1px solid #d4d4d4; line-height:30px; font-size:12px;">
                        <option value="0">-----------사용자 상태------</option>
                        {% for userStatus in userStatus_info %}
                            <option value={{userStatus.userStatus_idx}}>{{userStatus.userStatus}}</option>
                        {% endfor %}
                     </select>
                </div>
                <div class="input_area_lounge">
                      <select id="page_cnt" name="page_cnt" style="width:60px; height:35px; border:1px solid #d4d4d4; line-height:30px; font-size:12px;">
                        <option value="2">2(Test Ver.)</option>
                        <option value="10">10</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                     </select>
                </div>
                <div class="input_area_lounge" style="margin-left:-150px;">
                     <input type="text" name="search_box" id="search_box" value='{{search}}' placeholder="아이디 or 주문번호">
                </div>
                 <div class="btn_area">
                    <a class="btn" href="javascript:void(0);" onclick="javascript:goSearch(1);">&nbsp;조회하기&nbsp;</a>
                 </div>
            </div>
        </div>
    </div>

    <div style="margin-left: 300px; width: 1130px; font-size: 20px !important; padding-bottom:10px;">total : {{total_count}}
        <button type="button" style="color:#fff; background-color:#101a4e;	border-color:#101a4e; float:right; border-radius:5em; font-size: 20px" onclick="fnExcelReport('payList');">Excel</button>
    </div>
    <div style="overflow: hidden; position: relative; border: 0px; width: 100%;">
        <table id="payList" style="margin-left: 300px; width: 1130px;">
            <thread>
                <tr class="row">
                    <th class="admin_list_check">&nbsp;</th>
                    <th class="admin_list">이름</th>
                    <th class="admin_list_id">아이디</th>
                    <th class="admin_list_id">주문번호</th>
                    <th class="admin_list_id">사용자 상태</th>
                    <th class="admin_list">주문방법</th>
                    <th class="admin_list_id">구매키트(옵션사항)</th>
                    <th class="admin_list">결제금액</th>
                    <th class="admin_list_id">배송지</th>
                    <th class="admin_list">배송상태 변경</th>
                </tr>
            </thread>
            <tbody>
                {% for deposit in pay_info %}
                <tr class="row">
                    <td class="admin_list_body">
                        <input type="hidden" name="payIdx_{{forloop.counter0}}" id="payIdx_{{forloop.counter0}}" value={{deposit.pay_idx}}>
                         {% if deposit.pay_result == 0 %}
                             {% if ok_status == deposit.pay_user_status.userStatus_idx %}
                             <input type="checkbox" name="idxs" value={{deposit.pay_idx}}"></td>
                             {%else%}
                             <input type="checkbox" disabled name="idxs" value={{deposit.pay_idx}}"></td>
                             {% endif %}
                        {%else%}
                        <input type="checkbox" disabled name="idxs[]" value={{deposit.pay_idx}}"></td>
                        {% endif %}
                    <td class="admin_list_body">{{deposit.pay_user.regi_name}}</td>
                    <td class="admin_list_id_body">{{deposit.pay_user.regi_email}}</td>
                    <td class="admin_list_id_body">{{deposit.pay_num}}</td>
                    <td class="admin_list_id_body">{{deposit.pay_user_status.userStatus}}</td>
                    <td class="admin_list_body">{{deposit.payWay.name}}</td>
                    <td class="admin_list_id_body">
                        {% for order in order_info %}
                            {% if deposit.pay_num == order.pay_num %}
                                <br/>*****<br/>
                                {{order.prd.title}} - {{order.count}} 개
                                {% if order.option1_selectNum == 2 %}
                                    ({{order.prd.option1}})
                                {% endif %}
                                {% if order.option2_selectNum == 2 %}
                                    ({{order.prd.option2}})
                                {% endif %}
                                {% if order.option3_selectNum == 2 %}
                                    ({{order.prd.option3}})
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td class="admin_list_body">{{deposit.prd_total_price}}</td>
                    <td class="admin_list_id_body">{{deposit.delivery_name}}<br/>{{deposit.delivery_addr}}<br/>{{deposit.delivery_phone}}</td>
                    {% if deposit.pay_result == 0 %}
                        {% if ok_status == deposit.pay_user_status.userStatus_idx %}
                        <td class="admin_list_body"><a href="javascript:void(0);" onClick="javascript:change({{deposit.pay_idx}});" style="cursor:pointer;color:red;"><strong>배송중 변경하기</strong></a></td>
                        {% else %}
                        <td class="admin_list_body">배송중</td>
                        {% endif %}
                    {% elif deposit.pay_result == 100 %}
                    <td class="admin_list_body">결제전</td>
                    {% elif deposit.pay_result == 1 %}
                     <td class="admin_list_body">결제실패</td>
                    {% elif deposit.pay_result == 2 %}
                     <td class="admin_list_body">환불</td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="page">
            <ul id="paging" class="pagination modal"></ul>
        </div>
    </div>

    <div style="margin-left: 300px; width: 1130px; font-size: 20px !important; padding-top:50px; padding-bottom:150px;">
        <button type="button" style="color:#fff; background-color:#e1a394;	border-color:#e1a394; float:right; border-radius:5em; font-size: 20px;" onClick="javascript:change('all');">배송중으로 변경</button>
    </div>
</div>

    <script>

     $(document).ready(function() {
       $('#status').val('{{status}}').prop("selected",true);
       $('#page_cnt').val('{{page_cnt}}').prop("selected",true);

       var page = '{{last_page}}';
       var cur_page = '{{paging_num}}';

       page *= 1;

       for(var i = 1; i <= page; i ++)
       {
            if(i == cur_page)
                document.getElementById('paging').innerHTML += "<li><a href='javascript:void(0);' onclick='javascript:goSearch(" + i + ");' class='active num' >" + i + "</a></li>";
            else
                document.getElementById('paging').innerHTML += "<li><a href='javascript:void(0);' onclick='javascript:goSearch(" + i + ");' class='num' >" + i + "</a></li>";
       }

     });

     function goSearch(paging_num)
     {
        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;
        var page_cnt = document.getElementById('page_cnt').value;
        var searchBox = $('[name=search_box]').val();

        if(start_date == "" || end_date == "")
        {
            alert("날짜선택하세요");
            return false;
        }

        var status = document.getElementById("status").selectedIndex;
        if(status > 0)
            status = document.getElementById("status").value;

        var newForm = $('<form></form>');

        newForm.attr("name", "deposit_search");
        newForm.attr("method", "post");
        newForm.attr("action", "/pay_search/");

        newForm.append($('<input/>', {type: 'hidden', name: 'csrfmiddlewaretoken', value : '{{ csrf_token }}'}));
        newForm.append($('<input/>', {type: 'hidden', name: 'start_date', value : start_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'end_date', value : end_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'searchBox', value : searchBox }));
        newForm.append($('<input/>', {type: 'hidden', name: 'status', value : status }));
        newForm.append($('<input/>', {type: 'hidden', name: 'paging_num', value : paging_num }));
        newForm.append($('<input/>', {type: 'hidden', name: 'page_cnt', value : page_cnt }));

        newForm.appendTo('body');
        newForm.submit();

     }

     function fnExcelReport(id)
     {
        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;

        if(start_date == "" || end_date == "")
        {
            alert("날짜선택하세요");
            return false;
        }

        var tab_text = '<html xmlns:x="urn:schemas-microsoft-com:office:excel">';
        tab_text = tab_text + '<head><meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">';
        tab_text = tab_text + '<xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet>'
        tab_text = tab_text + '<x:Name>Test Sheet</x:Name>';
        tab_text = tab_text + '<x:WorksheetOptions><x:Panes></x:Panes></x:WorksheetOptions></x:ExcelWorksheet>';
        tab_text = tab_text + '</x:ExcelWorksheets></x:ExcelWorkbook></xml></head><body>';
        tab_text = tab_text + "<table border='1px'>";

        var exportTable = $('#' + id).clone();
        exportTable.find('input').each(function (index, elem) { $(elem).remove(); });
        tab_text = tab_text + exportTable.html();
        tab_text = tab_text + '</table></body></html>';
        var data_type = 'data:application/vnd.ms-excel';
        var ua = window.navigator.userAgent;
        var msie = ua.indexOf("MSIE ");


        title = start_date + "-" + end_date;
        var fileName = title + '.xls';

        //Explorer 환경에서 다운로드
        if (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./))
        {
            if (window.navigator.msSaveBlob)
            {
                var blob = new Blob([tab_text], {
                    type: "application/csv;charset=utf-8;"
                });
                navigator.msSaveBlob(blob, fileName);
            }
        }
        else
        {
            var blob2 = new Blob([tab_text], {
                type: "application/csv;charset=utf-8;"
            });
            var filename = fileName;
            var elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob2);
            elem.download = filename;
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(elem);
        }
     }


    function change(pay_idx)
    {
        var start_date = document.getElementById('start_date').value;
        var end_date = document.getElementById('end_date').value;
        var searchBox = $('[name=search_box]').val();

        if(start_date == "" || end_date == "")
        {
            alert("날짜선택하세요");
            return false;
        }

        var status = document.getElementById("status").selectedIndex;
        if(status > 0)
            status = document.getElementById("status").value;

        if(pay_idx == 'all')
        {
            var chks = document.getElementsByName('idxs');
            pay_idx = '';
             for (var i=0,m=chks.length;i<m ;i++)
             {
                if (chks[i].checked == true)
                {
                     var payIndex = document.getElementById("payIdx_" + i).value;

                     pay_idx += payIndex + ",";
                }
             }

             if(pay_idx == '')
             {
                alert("체크된 내용이 없습니다");
                return false;
             }
        }

        var newForm = $('<form></form>');

        newForm.attr("name", "pay_change");
        newForm.attr("method", "post");
        newForm.attr("action", "/pay_change/");

        newForm.append($('<input/>', {type: 'hidden', name: 'csrfmiddlewaretoken', value : '{{ csrf_token }}'}));
        newForm.append($('<input/>', {type: 'hidden', name: 'start_date', value : start_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'end_date', value : end_date }));
        newForm.append($('<input/>', {type: 'hidden', name: 'searchBox', value : searchBox }));
        newForm.append($('<input/>', {type: 'hidden', name: 'status', value : status }));
        newForm.append($('<input/>', {type: 'hidden', name: 'pay_idx', value : pay_idx }));

        newForm.appendTo('body');
        newForm.submit();
    }
    </script>
</body></html>